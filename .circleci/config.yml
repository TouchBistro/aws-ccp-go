version: 2.1

cache_key: &cache_key aws-ccp-go-20230530-{{ checksum "go.sum" }}

executors:
  docker-go:
    docker:
        - image: 651264383976.dkr.ecr.us-east-1.amazonaws.com/cimg-go:latest-extra
          aws_auth:
            aws_access_key_id: $AWS_ACCESS_KEY_ID
            aws_secret_access_key: $AWS_SECRET_ACCESS_KEY

commands:
  lint-test:
    steps:
      - checkout 
      - restore_cache:
          name: Restore dep cache
          keys: 
            - *cache_key 
      - run: 
         name: Install dependencies
         command: make setup
      - save_cache:
          name: Save dep cache 
          key: *cache_key
          paths: 
            - ~/go/pkg
            - bin/golangci-lint
      - run:
          name: Run linter
          command: make lint
      - run:
          name: Run test
          command: go test ./...
  codegen: 
    steps:
      - run: 
          name: run go generate
          command: go generate ./codegen/codegen.go
  build-code:
    steps: 
      - run: 
          name: Build code 
          command: make build

jobs:
  lint-build-test:
    executor: docker-go
    steps:
      - lint-test 
      - codegen
      - build-code
  release:
    executor: docker-go
    steps: 
      - lint-test 
      - build-code
      - run:
          name: tag & release
          command: echo "releasing this branch"

workflows:
  build-test-release:
    jobs:
     - lint-build-test:
         context: org-global 
     - release:
         context: org-global
         filters: 
           branches:
             ignore:
               - master #need to be flipped to ONLY run for `master` later
